<div class="row certificate_picker">
    <label class="control-label col-sm-3">{{ certificate.label }}</label>
    <div class="col-sm-8 col-xs-10">
        <select class="selectpicker " data-live-search="true"
                name="{{ certificate.name }}"
                id="id_{{ certificate.name }}" data-show-subtext="True">
            {% if certificate.value == None or certificate.value == '-1' %}
                <option value="-1" selected>Nothing selected!</option>
            {% endif %}
            {% for choise in certificate.field.queryset %}
                <option value="{{ choise.id }}"
                        {% if certificate.value|slugify == choise.id|slugify %}
                        selected{% endif %}
                        data-subtext="{{ choise }}">{{ choise.subject.cname }}</option>
            {% endfor %}
        </select>
        {% include "connections/forms/../widgets/errormsg.html" with field=certificate %}
    </div>
    <div class="col-sm-1 col-xs-2">
        {% include "connections/widgets/QuestionPopover.html" with title="User certificate help" content="Select a certificate which authenticates yourself. Only certificate with a private key are shown." %}
    </div>
    <div class="col-sm-11 col-xs-10">
        <div class="pull-right">
        <a data-toggle="modal" data-target="#AddCertificateModal">Upload new certificate</a>
            </div>
    </div>
</div>
<div class="row identity_picker">
    {% include "connections/forms/IdentitiesPicker.html" with identity=identity %}
</div>



    <!-- Modal -->
<div class="modal fade" id="AddCertificateModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Change your password</h4>
            </div>
            <div class="modal-body">
                <iframe src="{% url "certificates:add_form" %}" style="width: 100%; height: 600px;"></iframe>
                <button type="button" class="btn btn-default" data-dismiss="modal">Finish</button>
            </div>
        </div>
    </div>
</div>

<script>
    var previous = null;
    var div = $(".certificate_picker");
    var select = div.find("select");
    var identity_picker = $(".identity_picker");

    div.mouseenter(function (e) {
        // Store the current value on focus and on change
        var myselect = $(this).find("select");
        previous = myselect[0].value;
    });
    select.change(function () {
        // Make sure the previous value is updated
        previous = this.value;
        $.ajax( {
                type: 'POST',
                url: '{% url "connections:identities" %}',
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    'certififcate_id': previous
                },
                success: function(data){
                    identity_picker.html(data);
                    $('.selectpicker').selectpicker('refresh');
                },
                error: function(data){
                        console.log(data);
                }

        }
        );
        //form = $(this).closest("form");
        //form.find("#refresh_choices").val("True");
        //form.submit();
    });
</script>